openapi: 3.0.0
info:
  title: TFE Workspace Health Auditor API
  version: 1.0.0
  description: |
    Terraform Enterprise workspace health auditing with risk scoring and compliance mapping.
    Implements Observe + Analyze (stages 5-6) of the Instana-TFE-Vault Autonomic Loop.

    **7 Health Checks per Workspace:**
    - Run Health (L4 Visibility)
    - Sentinel Compliance (L5 Intelligence)
    - Drift Status (L4 Visibility)
    - Module Freshness (L5 Intelligence)
    - Tag Coverage (L5 Intelligence)
    - Variable Set Completeness (L5 Intelligence)
    - State Health (L4 Visibility)

    EXPERIMENTAL: NOT TESTED OR FOR PRODUCTION USE WITHOUT PROPER VALIDATION

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://tfe-health.watsonx.ibm.com
    description: Production watsonx Orchestrate deployment

tags:
  - name: Audit
    description: Workspace health scanning and risk assessment
  - name: Compliance
    description: Compliance framework rules for TFE workspace governance
  - name: Autonomic
    description: Autonomic loop stage mapping

paths:
  /audit-workspaces:
    post:
      operationId: auditWorkspaces
      summary: Audit TFE workspace health with risk scoring
      description: |
        Comprehensive workspace health audit combining:
        - Run health analysis (success/failure rates, apply duration)
        - Sentinel compliance checking (policy pass/fail, overrides)
        - Drift detection (plan-only analysis, resource changes)
        - Module freshness (version currency vs. registry)
        - Tag coverage (required tag validation)
        - Variable set completeness
        - State health (size, age, lock status)

        Returns risk-scored findings with prioritized remediation roadmap
        and autonomic loop events for Instana/Concert consumption.
      tags:
        - Audit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tfe_organization
              properties:
                tfe_organization:
                  type: string
                  description: TFE organization to scan
                  example: my-org
                workspace_filters:
                  type: array
                  description: Optional filters for workspace selection
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        enum:
                          - name
                          - tag
                        description: Filter type
                      value:
                        type: string
                        description: Filter value (glob pattern or tag)
                  example:
                    - type: tag
                      value: "env:production"
                include_run_history:
                  type: boolean
                  default: true
                  description: Include run success/failure analysis
                include_drift_check:
                  type: boolean
                  default: true
                  description: Include drift detection analysis
            examples:
              production_audit:
                summary: Audit production workspaces
                value:
                  tfe_organization: my-org
                  workspace_filters:
                    - type: tag
                      value: "env:production"
                  include_run_history: true
                  include_drift_check: true

              full_org_scan:
                summary: Full organization scan
                value:
                  tfe_organization: my-org
                  include_run_history: true
                  include_drift_check: true

      responses:
        '200':
          description: Audit results with risk-scored findings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditResult'
              examples:
                critical_findings:
                  summary: Audit with critical findings
                  value:
                    total_workspaces: 24
                    critical_count: 3
                    high_count: 7
                    medium_count: 10
                    low_count: 4
                    findings:
                      - id: a7f3d9e1c5b2
                        workspace_id: ws-abc123
                        workspace_name: prod-payments
                        organization: my-org
                        risk_score: 10
                        risk_level: critical
                        checks:
                          - check_name: drift_status
                            uhccp_layer: L4 Visibility
                            autonomic_stage: stage-5-observe
                            status: fail
                            detail: "Drift detected in production: 5 resources changed, 12 days old"
                            risk_points: 5
                          - check_name: sentinel_compliance
                            uhccp_layer: L5 Intelligence
                            autonomic_stage: stage-6-analyze
                            status: fail
                            detail: "3 hard fails (recent), 1 soft fail, 2 overrides in 15 checks"
                            risk_points: 3
                        tags:
                          "0": production
                          "1": pci-dss
                    remediation_roadmap:
                      P0_immediate:
                        - "my-org/prod-payments (risk: 10)"
                        - "my-org/prod-identity (risk: 9)"
                      P1_30_days:
                        - "my-org/staging-api (risk: 7)"
                      P2_90_days:
                        - "my-org/dev-sandbox (risk: 4)"
                    autonomic_loop_events:
                      - event_id: b2c4f7a9d6e8
                        timestamp: "2026-02-28T12:00:00Z"
                        autonomic_stage: stage-5-observe
                        uhccp_layer: L4 Visibility
                        workspace: prod-payments
                        organization: my-org
                        severity: critical
                        summary: "[drift_status] Drift detected in production: 5 resources changed"
                    estimated_impact:
                      potential_incident_cost_avoided: "$180,000"
                      workspaces_requiring_attention: 10
                      estimated_toil_reduction_hours_per_quarter: 52

        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '401':
          description: TFE authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /compliance-rules:
    get:
      operationId: getComplianceRules
      summary: Get compliance framework rules for TFE workspace governance
      description: |
        Returns compliance requirements mapped to workspace health checks from:
        - OCC 2023-01 (Operational Resilience)
        - FFIEC IT Handbook
        - DORA Article 11
        - PCI-DSS v4
        - SOX 404
        - NIST 800-53
      tags:
        - Compliance
      responses:
        '200':
          description: Compliance rules by framework
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
                  additionalProperties:
                    type: string
              example:
                OCC_2023-01:
                  operational_resilience: "Workspace drift must be detected and remediated within SLA"
                  change_management: "All infrastructure changes must pass Sentinel policy checks"
                PCI-DSS_v4:
                  requirement_6.3: "Infrastructure components must be kept current (module freshness)"
                  requirement_10.2: "All infrastructure changes must be logged and auditable"
                NIST_800-53:
                  CM-2: "Baseline configuration — state health validates configuration baseline"
                  CM-3: "Configuration change control — Sentinel policies enforce change control"

  /autonomic-loop-mapping:
    get:
      operationId: getAutonomicLoopMapping
      summary: Get autonomic loop stage mapping for this skill
      description: |
        Maps each health check to its stage in the 8-stage Instana-TFE-Vault
        autonomic loop. This skill owns stages 5-6 (Observe + Analyze).
      tags:
        - Autonomic
      responses:
        '200':
          description: Autonomic loop stage mapping
          content:
            application/json:
              schema:
                type: object
              example:
                autonomic_loop:
                  stage-5-observe:
                    owner: tfe-workspace-health
                    checks:
                      - run_health
                      - drift_status
                      - state_health
                  stage-6-analyze:
                    owner: tfe-workspace-health
                    checks:
                      - sentinel_compliance
                      - module_freshness
                      - tag_coverage
                      - variable_set_completeness

components:
  schemas:
    AuditResult:
      type: object
      required:
        - total_workspaces
        - critical_count
        - high_count
        - medium_count
        - low_count
        - findings
        - remediation_roadmap
        - autonomic_loop_events
        - estimated_impact
      properties:
        total_workspaces:
          type: integer
          description: Total workspaces audited
        critical_count:
          type: integer
          description: Workspaces with critical risk (score 9-10)
        high_count:
          type: integer
          description: Workspaces with high risk (score 7-8)
        medium_count:
          type: integer
          description: Workspaces with medium risk (score 4-6)
        low_count:
          type: integer
          description: Workspaces with low risk (score 1-3)
        findings:
          type: array
          items:
            $ref: '#/components/schemas/WorkspaceFinding'
        remediation_roadmap:
          $ref: '#/components/schemas/RemediationRoadmap'
        autonomic_loop_events:
          type: array
          items:
            $ref: '#/components/schemas/AutonomicEvent'
        estimated_impact:
          $ref: '#/components/schemas/EstimatedImpact'

    WorkspaceFinding:
      type: object
      required:
        - id
        - workspace_id
        - workspace_name
        - organization
        - risk_score
        - risk_level
        - checks
      properties:
        id:
          type: string
          description: Deterministic finding ID
        workspace_id:
          type: string
          description: TFE workspace ID
        workspace_name:
          type: string
          description: Workspace name
        organization:
          type: string
          description: TFE organization
        risk_score:
          type: integer
          minimum: 0
          maximum: 10
        risk_level:
          type: string
          enum: [critical, high, medium, low]
        checks:
          type: array
          items:
            $ref: '#/components/schemas/HealthCheck'
        tags:
          type: object
          additionalProperties:
            type: string
        metadata:
          type: object
          additionalProperties: true

    HealthCheck:
      type: object
      required:
        - check_name
        - uhccp_layer
        - autonomic_stage
        - status
        - detail
      properties:
        check_name:
          type: string
          enum:
            - run_health
            - sentinel_compliance
            - drift_status
            - module_freshness
            - tag_coverage
            - variable_set_completeness
            - state_health
        uhccp_layer:
          type: string
          enum: [L4 Visibility, L5 Intelligence]
        autonomic_stage:
          type: string
          enum: [stage-5-observe, stage-6-analyze]
        status:
          type: string
          enum: [pass, warn, fail]
        detail:
          type: string
        risk_points:
          type: integer
          minimum: 0
        metadata:
          type: object
          additionalProperties: true

    AutonomicEvent:
      type: object
      required:
        - event_id
        - timestamp
        - autonomic_stage
        - uhccp_layer
        - workspace
        - organization
        - severity
        - summary
      properties:
        event_id:
          type: string
        timestamp:
          type: string
          format: date-time
        autonomic_stage:
          type: string
        uhccp_layer:
          type: string
        workspace:
          type: string
        organization:
          type: string
        severity:
          type: string
          enum: [critical, high, medium, low]
        summary:
          type: string
        detail:
          type: object
          additionalProperties: true

    RemediationRoadmap:
      type: object
      properties:
        P0_immediate:
          type: array
          items:
            type: string
        P1_30_days:
          type: array
          items:
            type: string
        P2_90_days:
          type: array
          items:
            type: string

    EstimatedImpact:
      type: object
      properties:
        potential_incident_cost_avoided:
          type: string
          description: Formatted currency estimate
        workspaces_requiring_attention:
          type: integer
        estimated_toil_reduction_hours_per_quarter:
          type: integer
        compliance_gaps_found:
          type: integer
        business_summary:
          type: string

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: |
        TFE API token for authentication.
        Set TFE_TOKEN environment variable or pass as Bearer token.

security:
  - BearerAuth: []
